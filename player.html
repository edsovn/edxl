<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player JWPlayer</title>
  <script src="//ssl.p.jwpcdn.com/player/v/8.36.4/jwplayer.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>jwplayer.key = 'XsK+VuloUK5YB+O7Z6I3aD4DP42TKEoQd2MLvA==';</script>
  <style>
    #player {
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    ._4continuar {
      color: #fff;
      min-height: 6em;
      padding: 18px;
      margin: 10px;
      width: 100%;
      text-align: left;
      border-radius: 4px;
      background: #292929;
    }
    ._4continuar bt {
      padding: 10px;
      background: #383838;
      width: calc(50% - 10px);
      margin: 5px;
      display: inline-block;
      border-radius: 4px;
      cursor: pointer;
    }
    ._4continuar bt:hover { background: #504f4f; }
  </style>
</head>
<body>

<!-- Player sempre visível -->
<div id="player"></div>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const videoUrl = getQueryParam('video');
    if (!videoUrl) {
      document.body.innerHTML = "<p style='color:white;background:#000;padding:1em;'>Nenhum vídeo especificado na URL</p>";
      return;
    }

    const playerId = "player";
    const uniqueID = "w" + playerId;
    const storageKey = "jw_" + uniqueID;
    const currentPosition = parseFloat(localStorage.getItem(storageKey));
    let lock = false;

    jwplayer(playerId).setup({
      file: videoUrl,
      width: "100%",
      height: "100%",
      controls: true,
      autostart: true,
      displaytitle: true,
      aboutlink: 'https://webmods.com.br/',
      localization: {
        fullscreen: "Tela Cheia",
        hd: "Qualidade",
        copied: "Copiado",
        playbackRates: "Velocidade da reprodução",
        videoInfo: "Sobre este vídeo",
        rewind: "Voltar 10s",
        forward: "Avançar 10s",
        settings: "Configurações",
        loadingAd: "Carregando anúncio",
      },
      playbackRateControls: "[0.25, 0.5, 0.75, 1, 1.25, 1.5, 2]",
      plugins: { snapshot: {} }
    });

    jwplayer(playerId).on('play', function () {
      if (!lock && currentPosition && currentPosition > 0) {
        jwplayer(playerId).pause();
        const boxId = "_4continuar_" + playerId;
        const boxHtml = `
          <div class="_4continuar" id="${boxId}">
            <p>Você parou em ${millisToMinutesAndSeconds(currentPosition)}. Deseja continuar?</p>
            <bt data-time="${currentPosition}">Sim</bt>
            <bt data-time="0">Não</bt>
          </div>`;
        document.getElementById(playerId).insertAdjacentHTML("beforeend", boxHtml);
        document.querySelectorAll(`#${boxId} > bt`).forEach(function (bt) {
          bt.addEventListener("click", function () {
            const startIn = parseFloat(this.getAttribute("data-time"));
            document.getElementById(boxId).remove();
            jwplayer(playerId).seek(startIn);
            jwplayer(playerId).play();
          });
        });
      }
      lock = true;
      (function ping() {
        localStorage.setItem(storageKey, jwplayer(playerId).getPosition());
        setTimeout(ping, 1000);
      })();
    });

    jwplayer(playerId).on("beforePlay", function () {
      function tryMoveButtons(attempts = 10) {
        const player = jwplayer(playerId);
        const container = player.getContainer().querySelector(".jw-button-container");
        const rewind = player.getContainer().querySelector("[button='rewind']");
        const forward = player.getContainer().querySelector("[button='forward']");
        const skip = player.getContainer().querySelector("[button='pula-opening']");

        if (container && rewind && forward && skip && container.children.length) {
          const buttons = container.children;
          const playButton = buttons[0];
          if (playButton) {
            container.insertBefore(rewind, playButton.nextSibling);
            container.insertBefore(forward, rewind.nextSibling);
            container.insertBefore(skip, forward.nextSibling);
          }
        } else if (attempts > 0) {
          setTimeout(() => tryMoveButtons(attempts - 1), 100);
        }
      }
      tryMoveButtons();
    });

    jwplayer(playerId).addButton("https://www.anitube.vip/img/skip.svg?version=0.0.1", "Pular OP/ED", function () {
      jwplayer(playerId).seek(jwplayer(playerId).getPosition() + 83);
    }, "pula-opening");

    jwplayer(playerId).addButton("⏩", "Avançar 10s", function () {
      jwplayer(playerId).seek(jwplayer(playerId).getPosition() + 10);
    }, "forward");

    jwplayer(playerId).addButton("⏪", "Voltar 10s", function () {
      const pos = jwplayer(playerId).getPosition();
      jwplayer(playerId).seek(pos >= 10 ? pos - 10 : 0);
    }, "rewind");

    jwplayer(playerId).addButton("⬇️", "Baixar", function () {
      let downloadUrl = videoUrl;
      if (/\.mp4$/i.test(downloadUrl)) downloadUrl += "?dl=1";
      downloadUrl = downloadUrl.replace(/&raw=1$/, "&dl=1");
      window.location.href = downloadUrl;
    }, "download");

    function millisToMinutesAndSeconds(time) {
      const min = Math.floor(time / 60);
      const sec = Math.floor(time % 60).toString().padStart(2, "0");
      return `${min}:${sec}`;
    }
  });
</script>
</body>
</html>
